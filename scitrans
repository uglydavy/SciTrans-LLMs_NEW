#!/bin/bash
# SciTrans LLMs - Scientific Document Translation
# This script ensures the correct Python environment is used

# Resolve symlinks to get the actual script location
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
    DIR="$( cd -P "$( dirname "$SOURCE" )" &> /dev/null && pwd )"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" &> /dev/null && pwd )"

# Try .venv312 first (for ultralytics/Python 3.12), fall back to .venv
if [ -f "$SCRIPT_DIR/.venv312/bin/python3" ]; then
    VENV_DIR="$SCRIPT_DIR/.venv312"
elif [ -f "$SCRIPT_DIR/.venv/bin/python3" ]; then
    VENV_DIR="$SCRIPT_DIR/.venv"
else
    echo "Virtual environment not found. Please create one:"
    echo "  For Python 3.12 (with ultralytics): python3.12 -m venv .venv312 && .venv312/bin/pip install -e ."
    echo "  For Python 3.13: python3 -m venv .venv && .venv/bin/pip install -e ."
    exit 1
fi

PYTHON="$VENV_DIR/bin/python3"

# Check if venv exists
if [ ! -f "$PYTHON" ]; then
    echo "Virtual environment not found at $VENV_DIR"
    echo "Please run: cd $SCRIPT_DIR && pip install -e ."
    exit 1
fi

# Run the appropriate command
case "$1" in
    gui)
        # Parse port argument if provided
        PORT=7860
        shift
        while [[ $# -gt 0 ]]; do
            case "$1" in
                --port)
                    PORT="$2"
                    shift 2
                    ;;
                *)
                    shift
                    ;;
            esac
        done
        
        # Set environment variables for Apple Silicon compatibility
        export POLARS_SKIP_CPU_CHECK=1  # Skip Polars CPU check (running under Rosetta)
        export PYTORCH_ENABLE_MPS_FALLBACK=1  # Enable CPU fallback for unsupported MPS ops
        
        # Suppress PyTorch MPS warnings (expected behavior on Apple Silicon)
        export PYTHONWARNINGS="ignore::UserWarning:torch.*"
        
        echo "Launching SciTrans GUI on port $PORT..."
        exec "$PYTHON" -c "
import sys
sys.path.insert(0, '$SCRIPT_DIR')
from gui.app import launch
launch(port=$PORT)
"
        ;;
    help|--help|-h)
        cat << EOF
SciTrans LLMs - Scientific Document Translation

Usage:
  scitrans gui                     Launch web GUI
  scitrans translate <pdf>         Translate a PDF
  scitrans translate <pdf> -o out  Translate with output path
  scitrans test                    Run system tests
  scitrans backends                List available backends
  scitrans info                    Show system information
  scitrans info <pdf>              Show PDF information
  scitrans keys list               List API keys
  scitrans keys set -b <name> -k <key>  Set API key
  scitrans keys delete -b <name>   Delete API key
  scitrans keys check              Check API key availability
  scitrans wizard                  Interactive wizard
  scitrans cli                     Enter CLI mode
  scitrans help                    Show this help

Examples:
  scitrans gui
  scitrans translate paper.pdf
  scitrans translate paper.pdf --backend openai -o translated.pdf
  scitrans info
  scitrans keys set -b openai -k sk-...
  scitrans backends
EOF
        ;;
    *)
        # Default: pass all arguments to CLI
        exec "$PYTHON" -m cli.commands.main "$@"
        ;;
esac
